{% extends 'base.html' %}
{% load widget_tweaks %} {# si tu utilises add_class, par ex. #}

{% block content %}
<h2 class="mb-4">Inscription Streamer</h2>

<form method="POST" class="row g-3">
  {% csrf_token %}
  {{ streamer_form.non_field_errors }}
  <!-- Nom Twitch + bouton Rechercher -->
  <div class="col-12">
    <label for="id_twitch_name" class="form-label">Nom Twitch</label>
    <div class="input-group">
      {{ streamer_form.twitch_name }}
      {% for error in streamer_form.twitch_name.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
      <button type="button" class="btn btn-outline-secondary" id="btnFetchTwitch">
        Rechercher
      </button>
    </div>
  </div>

  <!-- Email -->
  <div class="col-md-6">
    <label for="id_email" class="form-label">Email</label>
    {{ streamer_form.email }}
  </div>

  <!-- Discord -->
  <div class="col-md-6">
    <label for="id_discord" class="form-label">Pseudo Discord</label>
    {{ streamer_form.discord }}
  </div>

  <!-- Mode Présence Radio -->
  <div class="col-12">
    <label class="form-label">Mode de présence</label><br>
    {{ streamer_form.presence_mode }}
  </div>

  <!-- Description -->
  <div class="col-12">
    <label for="id_description" class="form-label">Description</label>
    {{ streamer_form.description }}
  </div>

  <!-- Profile Image URL + Aperçu -->
  <div class="col-md-6">
    <label for="id_profile_image_url" class="form-label">URL de l'image</label>
    {{ streamer_form.profile_image_url }}
  </div>
  <div class="col-md-6">
    <label class="form-label d-block">Aperçu</label>
    <img id="previewImg" src="" alt="Preview" style="width: 120px; display: none;">
  </div>

  <hr class="my-4">
  <h4>Réseaux sociaux</h4>

  

  <div id="socialFormset">
    {{ formset.management_form }}
    {% for form in formset %}
    <div class="card mb-2 p-2 border" data-form-index="{{ forloop.counter0 }}">
      <div class="d-flex justify-content-end">
        <!-- Bouton pour supprimer -->
        <button type="button" class="btn-close remove-social"></button>
      </div>

      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Réseau</label>
          <!-- Ajoutons la classe form-select -->
          {{ form.network|add_class:"form-select" }}
        </div>
        <div class="col-md-6">
          <label class="form-label">Pseudo</label>
          {{ form.username|add_class:"form-control" }}
        </div>
      </div>
      {{ form.id }}
      {% if form.DELETE %}
      <!-- On cache la case DELETE -->
      <div style="display:none;">
        {{ form.DELETE }}
      </div>
    {% endif %}
    </div>
    {% endfor %}
  </div>

  <!-- Template caché pour un nouveau réseau -->
  <div id="emptySocialTemplate" class="card mb-2 p-2 border d-none">
    <div class="d-flex justify-content-end">
      <button type="button" class="btn-close remove-social"></button>
    </div>
    <div class="row g-2">
      <div class="col-md-6">
        <label class="form-label">Réseau</label>
        <select name="social_accounts-__prefix__-network" class="form-select" id="id_social_accounts-__prefix__-network">
          <option value="">---------</option>
          <option value="twitter">Twitter</option>
          <option value="youtube">YouTube</option>
          <option value="instagram">Instagram</option>
          <option value="facebook">Facebook</option>
          <option value="tiktok">TikTok</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Pseudo</label>
        <input type="text" name="social_accounts-__prefix__-username" class="form-control" id="social_accounts-__prefix__-username">
      </div>
    </div>
    <input type="hidden" name="social_accounts-__prefix__-id" id="social_accounts-__prefix__-id">
    <input type="checkbox" name="social_accounts-__prefix__-DELETE" id="social_accounts-__prefix__-DELETE" style="display:none;">
  </div>

  <button type="button" id="addSocial" class="btn btn-secondary my-2">+ Ajouter un réseau</button>
  <hr>

  <div class="col-12">
    <button type="submit" class="btn btn-primary">Valider</button>
  </div>
</form>

<!-- Script API Twitch -->
<script>
document.getElementById("btnFetchTwitch").addEventListener("click", function() {
  const username = document.getElementById("id_twitch_name").value.trim();
  if(!username){
    alert("Veuillez entrer un nom Twitch.");
    return;
  }

   // 1) Vérif DB interne (pour doublon)
  fetch(`/ajax/check_twitch_name/?username=${encodeURIComponent(username)}`)
    .then(response => response.json())
    .then(data => {
      if(data.error) {
        alert("Erreur: " + data.error);
        return;
      }
      if(data.exists) {
        alert("Ce nom Twitch est déjà pris. Merci d'en choisir un autre.");
        // éventuellement, on s’arrête avant d’appeler l’API Twitch
        return;
      }

  fetch(`/ajax/fetch_twitch_info/?username=${encodeURIComponent(username)}`)
    .then(response => response.json())
    .then(data => {
      if(data.error){
        alert("Erreur: " + data.error);
        return;
      }
      // On remplit la description
      document.getElementById("id_description").value = data.description || "";
      // On remplit l'URL d'image
      const imgUrlInput = document.getElementById("id_profile_image_url");
      const previewImg = document.getElementById("previewImg");
      if(data.profile_image_url){
        imgUrlInput.value = data.profile_image_url;
        previewImg.src = data.profile_image_url;
        previewImg.style.display = "inline";
      }
    })
    .catch(err => console.error(err));
  })
  .catch(err => console.error(err));
});
</script>

<!-- Script pour le formset dynamique -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const addBtn = document.getElementById("addSocial");
  const formsetDiv = document.getElementById("socialFormset");
  const emptyTemplate = document.getElementById("emptySocialTemplate");

  addBtn.addEventListener("click", function() {
    let totalForms = document.getElementById("id_social_accounts-TOTAL_FORMS");
    let formIndex = parseInt(totalForms.value);

    // On clone le template
    let newForm = emptyTemplate.cloneNode(true);
    newForm.classList.remove("d-none");

    // Remplacer `__prefix__` par l'index courant
    let html = newForm.innerHTML;
    html = html.replace(/__prefix__/g, formIndex);
    newForm.innerHTML = html;

    // On ajoute ce nouveau bloc dans la div
    formsetDiv.appendChild(newForm);

    // Incrémenter le nombre total de forms
    totalForms.value = formIndex + 1;
  });

  // Gérer la suppression
  document.addEventListener("click", function(e) {
    if(e.target && e.target.classList.contains("remove-social")){
      let card = e.target.closest(".card");
      let delCheckbox = card.querySelector("input[type='checkbox']");
      if(delCheckbox) {
        delCheckbox.checked = true;
      }
      card.style.display = "none";
    }
  });
});
</script>
{% endblock %}