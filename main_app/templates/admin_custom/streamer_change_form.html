{% extends "admin/change_form.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
  /* Eventuellement, un peu de style pour le bouton */
  #fetch-twitch-btn {
    margin-top: 0.5rem;
  }
</style>
{% endblock %}

{% block after_field_sets %}
{{ block.super }}

{# On insère notre bouton "Rechercher" à côté de "twitch_name" #}
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Sélectionner le champ 'twitch_name'
  const twitchNameInput = document.getElementById("id_twitch_name");
  if (!twitchNameInput) return;

  // Créer le bouton
  const btn = document.createElement("button");
  btn.type = "button";
  btn.id = "fetch-twitch-btn";
  btn.className = "btn btn-secondary";
  btn.innerText = "Rechercher (API Twitch)";

  // Insérer le bouton juste après le champ
  twitchNameInput.insertAdjacentElement("afterend", btn);

  // Au clic, on fait un fetch vers la vue AJAX
  btn.addEventListener("click", function() {
    const username = twitchNameInput.value.trim();
    if (!username) {
      alert("Veuillez entrer un Twitch Name");
      return;
    }

    const url = `/ajax/fetch_twitch_info/?username=${encodeURIComponent(username)}`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert("Erreur : " + data.error);
          return;
        }
        // Récupérer les champs du formulaire
        const emailInput = document.getElementById("id_email");
        const descInput = document.getElementById("id_description");
        const broadcasterInput = document.getElementById("id_broadcaster_type");
        const followerInput = document.getElementById("id_follower_count");
        const profileImgInput = document.getElementById("id_profile_image_url");

        if (emailInput) emailInput.value = data.email || "";
        if (descInput) descInput.value = data.description || "";
        if (broadcasterInput) broadcasterInput.value = data.broadcaster_type || "";
        if (followerInput) followerInput.value = data.follower_count || 0;
        if (profileImgInput) profileImgInput.value = data.profile_image_url || "";

        alert("Informations Twitch mises à jour !");
      })
      .catch(err => {
        console.error(err);
        alert("Une erreur s'est produite lors de l'appel à l'API Twitch.");
      });
  });
});
</script>
{% endblock %}
