{% extends "base.html" %}
{% block title %}Accueil{% endblock %}
{% block content %}
<div class="container text-center">
  <h2>Bienvenue sur Charity Streaming</h2>
  <p>Ceci est la page d'accueil de votre site.</p>
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registrationModal">
    Rejoindre l'aventure
  </button>
</div>

<!-- Modal d'inscription -->
<div class="modal fade" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="registrationForm" method="post" action="{% url 'accounts:public_registration' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="registrationModalLabel">Inscription</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <!-- Menu déroulant pour choisir le type d'inscription -->
          <div class="mb-3">
            <label for="registration_type" class="form-label">Choisissez votre type d'inscription</label>
            <select class="form-select" id="registration_type" name="registration_type">
              <option value="">-- Sélectionnez --</option>
              <option value="streamer">Streamer</option>
              <option value="staff">Staff</option>
            </select>
          </div>
          <!-- Formulaire Streamer -->
          <div id="streamerForm" style="display: none;">
            <h5>Inscription Streamer</h5>
            <div class="mb-3">
              <label for="id_twitch_name" class="form-label">Twitch Name</label>
              <div class="input-group">
                {{ streamer_form.twitch_name }}
                <button type="button" id="searchTwitchBtn" class="btn btn-secondary">Rechercher</button>
              </div>
            </div>
            <div class="mb-3">
              <label for="id_description" class="form-label">Description</label>
              {{ streamer_form.description }}
            </div>
            {{ streamer_form.profile_image_url }} {# Champ caché #}
            <div class="mb-3">
              <label class="form-label">Aperçu de l'image de profil</label>
              <div id="profileImagePreview"></div>
            </div>
            <div class="mb-3">
              <label for="id_email" class="form-label">Adresse email</label>
              {{ streamer_form.email }}
            </div>
            <div class="mb-3">
              <label for="id_discord" class="form-label">Discord</label>
              {{ streamer_form.discord }}
            </div>
          </div>
          <!-- Formulaire Staff -->
          <div id="staffForm" style="display: none;">
            <h5>Inscription Staff</h5>
            {{ staff_form.as_p }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Envoyer</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const registrationSelect = document.getElementById('registration_type');
  const streamerFormDiv = document.getElementById('streamerForm');
  const staffFormDiv = document.getElementById('staffForm');
  const searchBtn = document.getElementById("searchTwitchBtn");
  const twitchNameInput = document.getElementById("id_twitch_name");
  const descriptionField = document.getElementById("id_description");
  const profileImageHidden = document.getElementById("id_profile_image_url");
  const profileImagePreview = document.getElementById("profileImagePreview");
  
  registrationSelect.addEventListener('change', function() {
    const val = registrationSelect.value;
    if(val === 'streamer'){
      streamerFormDiv.style.display = 'block';
      staffFormDiv.style.display = 'none';
    } else if(val === 'staff'){
      staffFormDiv.style.display = 'block';
      streamerFormDiv.style.display = 'none';
    } else {
      streamerFormDiv.style.display = 'none';
      staffFormDiv.style.display = 'none';
    }
  });

  searchBtn.addEventListener("click", function() {
    const twitchName = twitchNameInput.value.trim();
    if (!twitchName) {
      alert("Veuillez saisir un nom Twitch.");
      return;
    }
    
    fetch("{% url 'twitch:ajax_fetch_streamer_info' %}?twitch_name=" + encodeURIComponent(twitchName))
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
          descriptionField.value = "";
          profileImageHidden.value = "";
          profileImagePreview.innerHTML = "";
        } else {
          // Pré-remplissage des champs
          descriptionField.value = data.description;
          profileImageHidden.value = data.profile_image_url;
          profileImagePreview.innerHTML = '<img src="' + data.profile_image_url + '" alt="Image de profil" class="img-fluid" style="max-width:200px;">';
          // Message flash côté client (optionnel)
          alert("Informations récupérées avec succès !");
        }
      })
      .catch(error => {
        console.error("Erreur lors de la récupération des infos Twitch :", error);
        alert("Une erreur s'est produite, réessayez plus tard.");
      });
  });
});
</script>
{% endblock %}
