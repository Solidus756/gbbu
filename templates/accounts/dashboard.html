{% extends "base_dashboard.html" %}
{% block title %}Dashboard - Charity Streaming{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar persistante -->
    <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse" id="sidebarMenu">
      <div class="position-sticky pt-3">
        <h3 class="text-white px-3">Menu</h3>
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link text-white" href="{% url 'accounts:dashboard' %}">
              <i class="fas fa-user"></i> Mon Profil
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="{% url 'notifications:dashboard' %}">
              <i class="fas fa-bell"></i> Notifications 
              {% if notif_count > 0 %}
                <span class="badge bg-danger">{{ notif_count }}</span>
              {% endif %}
            </a>
          </li>
          {% if is_staff %}
          <li class="nav-item">
            <a class="nav-link text-white" href="{% url 'staff:staff_effectif' %}">
              <i class="fas fa-users"></i> Staff Effectif
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="{% url 'staff:candidatures' %}">
              <i class="fas fa-user-plus"></i> Candidatures
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="{% url 'staff:reserve' %}">
              <i class="fas fa-user-clock"></i> Réserve
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="{% url 'staff:postes' %}">
              <i class="fas fa-briefcase"></i> Postes
            </a>
          </li>
          {% endif %}
        </ul>
      </div>
    </nav>

    <!-- Contenu principal -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="card mb-4">
        <div class="card-header">
          <h4>Résumé du Profil</h4>
        </div>
        <div class="card-body">
          <p><strong>Nom d'utilisateur :</strong> {{ user.username }}</p>
          {% if is_streamer %}
            <p><strong>Twitch :</strong> {{ user.streamer_profile.twitch_name }}</p>
            <p><strong>Email :</strong> {{ user.streamer_profile.email }}</p>
            <p><strong>Description :</strong> {{ user.streamer_profile.description }}</p>
            <p><strong>Discord :</strong> {{ user.streamer_profile.discord }}</p>
            <div>
              <strong>Image de chaîne :</strong><br>
              <img src="{{ user.streamer_profile.profile_image_url }}" alt="Image de chaîne" class="img-fluid" style="max-width:200px;">
            </div>
            <p><strong>Réseaux Sociaux :</strong></p>
            <ul class="list-group">
              {% for soc in user.streamer_profile.social_accounts.all %}
                <li class="list-group-item">
                  {% if soc.network == "twitter" %}
                    <i class="fab fa-twitter"></i>
                  {% elif soc.network == "youtube" %}
                    <i class="fab fa-youtube"></i>
                  {% elif soc.network == "instagram" %}
                    <i class="fab fa-instagram"></i>
                  {% elif soc.network == "facebook" %}
                    <i class="fab fa-facebook"></i>
                  {% elif soc.network == "tiktok" %}
                    <i class="fab fa-tiktok"></i>
                  {% endif %}
                  {{ soc.username }}
                </li>
              {% empty %}
                <li class="list-group-item">Aucun réseau social enregistré.</li>
              {% endfor %}
            </ul>
          {% endif %}

          {% if is_staff and staff_app %}
            <hr>
            <h5>Détails Staff</h5>
            <p><strong>Pseudo :</strong> {{ staff_app.pseudo }}</p>
            <p><strong>Pseudo Discord :</strong> {{ staff_app.pseudo_discord }}</p>
            <p><strong>Pseudo Twitch :</strong> {{ staff_app.pseudo_twitch }}</p>
            <p><strong>Email :</strong> {{ staff_app.email }}</p>
            <p><strong>Poste demandé :</strong> {{ staff_app.poste_demande.poste }}</p>
            <p><strong>Pourquoi je veux rejoindre le staff :</strong> {{ staff_app.pourquoi }}</p>
            <p><strong>Status :</strong> {{ staff_app.get_status_display }}</p>
          {% endif %}
          
          <!-- Bouton pour ouvrir la modale d'édition directement -->
          <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#profileEditModal">
            Modifier mon Profil
          </button>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Modale d'édition du profil intégrée -->
<div class="modal fade" id="profileEditModal" tabindex="-1" aria-labelledby="profileEditModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" id="profileEditForm" action="{% url 'accounts:profile_edit' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="profileEditModalLabel">Modifier mon Profil</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <!-- Champs du profil streamer -->
          <div class="mb-3">
            <label for="id_twitch_name" class="form-label">Twitch Name</label>
            {{ streamer_form.twitch_name }}
            <button type="button" id="refreshTwitchBtn" class="btn btn-secondary mt-2">Raffraichir via Twitch</button>
          </div>
          <div class="mb-3">
            <label for="id_email" class="form-label">Adresse email</label>
            {{ streamer_form.email }}
          </div>
          <div class="mb-3">
            <label for="id_description" class="form-label">Description</label>
            {{ streamer_form.description }}
          </div>
          <div class="mb-3">
            <label for="id_discord" class="form-label">Discord</label>
            {{ streamer_form.discord }}
          </div>
          {{ streamer_form.profile_image_url }} {# Champ caché #}
          <div class="mb-3">
            <label class="form-label">Aperçu de l'image de chaîne</label>
            <div id="profileImagePreview">
              {% if user.streamer_profile.profile_image_url %}
                <img src="{{ user.streamer_profile.profile_image_url }}" alt="Image de chaîne" class="img-fluid" style="max-width:200px;">
              {% endif %}
            </div>
          </div>
          <!-- Section réseaux sociaux -->
          <h5>Réseaux Sociaux</h5>
          <div id="social-accounts-container">
            {{ social_formset.management_form }}
            {% for form in social_formset %}
              <div class="social-account-form mb-2">
                {{ form.as_p }}
              </div>
            {% endfor %}
          </div>
          <div id="empty-form-template" style="display: none;">
            {{ social_forms
